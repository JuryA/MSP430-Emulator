<!--
  MSP430 Emulator
  Copyright (C) 2016 Rudolf Geosits (rgeosits@live.esu.edu)  
                                                                      
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
                                                                   
  This program is distributed in the hope that it will be useful, 
  but WITHOUT ANY WARRANTY; without even the implied warranty of 
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.          
                                                       
  You should have received a copy of the GNU General Public License
  along with this program. If not, see <http://www.gnu.org/licenses
-->
           
<!DOCTYPE html>
<html lang="en-US">
<meta charset="utf-8"/>

<html>
    <head>
	<link rel="stylesheet" type="text/css" href="emu.css">

	<!-- Load the Paper.js library -->
	<script type="text/javascript" src="js/paper.js"></script>
	<script type="text/paperscript" canvas="myCanvas">

	 var IMG_BASE = new Point(0, 0);

	 var ws = new WebSocket('ws://127.0.0.1:9000', 'emu-protocol');
	 //var ws = new WebSocket('ws://poorhackers.com:9000', 'emu-protocol');

	 var msp_image = new Raster('msp', IMG_BASE.x + 142.5, IMG_BASE.y + 185.5);

	 var reset_button_down_image = new Raster('button_down', IMG_BASE.x + 215, IMG_BASE.y + 345);
	 reset_button_down_image.visible = false;

	 var P1_3_button_down_image = new Raster('button_down', IMG_BASE.x + 28, IMG_BASE.y + 345);
	 P1_3_button_down_image.visible = false;

	 var P1_0_LED_image = new Raster('P1_0_LED', IMG_BASE.x + 70, IMG_BASE.y + 361.5);
	 P1_0_LED_image.visible = false;

	 var P1_6_LED_image = new Raster('P1_6_LED', IMG_BASE.x + 84, IMG_BASE.y + 361);
	 P1_6_LED_image.visible = false;

	 var stdout = document.getElementById('console');
	 stdout.value = "";

	 function print_console (text){
	     var another = stdout.value + text;
	     stdout.value = another;

	     stdout.scrollTop = stdout.scrollHeight;
	 }
	 
	 var pause_button = document.getElementById('pause_button');
	 var play_button = document.getElementById('play_button');
	 var enter_button = document.getElementById('enter_button');
	 var upload_button = document.getElementById('upload_button');

	 // upload binary file //
	 var contents;

	 upload_button.onclick = function(){	     
	     ws.send("UPLOAD", { binary: false});
	     ws.send(contents, { binary: true });
	     ws.send("NPLOAD", { binary: false});
	 };

	 function readSingleFile(e) {
	     var file = e.target.files[0];
	     if (!file) {
		 return;
	     }

	     var reader = new FileReader();
	     
	     reader.onload = function(e) {
		 contents = e.target.result;
	     };

	     reader.readAsArrayBuffer(file);
	 }

	 document.getElementById('file-input').addEventListener('change', readSingleFile, false);
	 //
	 
	 var prev_cmd = "";
	 enter_button.onclick = function(){
	     if (stdin.value == "") {
		 if (prev_cmd != "")
		     stdin.value = prev_cmd;
		 else 
		     return;
	     }
	     else {
		 prev_cmd = stdin.value;
	     }

	     ws.send(stdin.value);
	     stdin.value = "";
	 };

	 pause_button.onclick = function(){
	     ws.send("PAUSE");
	 };

	 play_button.onclick = function(){
	     ws.send("PLAY");
	 };	 

	 function onMouseDown (event) {
	     var x = event.point.x;
	     var y = event.point.y;

	     ws.send(x); ws.send(y);

	     if (x >= (IMG_BASE.x + 15) && x <= (IMG_BASE.x + 49)) {
		 if (y >= (IMG_BASE.y + 327) && y <= (IMG_BASE.y + 360)) {
		     P1_3_button_down_image.visible = true;
		 }
	     }

	     if (x >= (IMG_BASE.x + 199) && x <= (IMG_BASE.x + 232)) {
		 if (y >= (IMG_BASE.y + 327) && y <= (IMG_BASE.y + 360)) {
		     reset_button_down_image.visible = true;
		 }
	     }	     
	     paper.view.update();
	 }

	 function onMouseUp (event) {
	     P1_3_button_down_image.visible = false;
	     reset_button_down_image.visible = false;
	     
	     paper.view.update();
	 }

	 ws.onmessage =  function (event) {
	     var msg = event.data;
	     
	     switch (msg) {
		 case "RED_ON": {
		     P1_0_LED_image.visible = true;
		     break;
		 }

		 case "RED_OFF": {
		     P1_0_LED_image.visible = false;
		     break;
		 }

		 case "GREEN_ON": {
		     P1_6_LED_image.visible = true;
		     break;
		 }

		 case "GREEN_OFF": {
		     P1_6_LED_image.visible = false;
		     break;
		 }
		     
		 // Line of text for the console
		 default: {
		     print_console(msg);
		     break;
		 }
	     }

	     paper.view.update();
	 };

	 stdin.onkeydown = function auto_enter (event) {
	     // On enter key press
	     if (event.keyCode == 13) {
                 enter_button.click();
	     }
	 };

	</script>
    </head>
    
    <body>
	<textarea id="console" rows="24" cols="80" readonly="readonly" class="STDOUT"></textarea>
	<br>

	<input type="text" id="stdin" width="80" class="STDIN">

	<br><br>

	<button id="enter_button" hidden="true">enter</button> 
	<button id="pause_button">Pause</button>
	<button id="play_button">Play</button>

	<input type="file" id="file-input" />
	<button id="upload_button">Upload</button>

	<canvas id="myCanvas" width="340" height="400" class="canvas"></canvas>
	<img id="msp" src="msp.png" alt="msp" hidden="true"></img>
	<img id="button_down" src="pushed.png" alt="button_down" hidden="true"></img>
	<img id="P1_0_LED" src="P1_0_LED.png" alt="P1_0_LED" hidden="true"></img>
	<img id="P1_6_LED" src="P1_6_LED.png" alt="P1_6_LED" hidden="true"></img>
    </body>
</html>
