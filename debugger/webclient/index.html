<!--
  MSP430 Emulator
  Copyright (C) 2014, 2015 Rudolf Geosits (rgeosits@live.esu.edu)  
                                                                      
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
                                                                   
  This program is distributed in the hope that it will be useful, 
  but WITHOUT ANY WARRANTY; without even the implied warranty of 
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.          
                                                       
  You should have received a copy of the GNU General Public License
  along with this program. If not, see <http://www.gnu.org/licenses
-->
           
<!DOCTYPE html>
<html lang="en-US">
<meta charset="utf-8"/>

<html>
    <head>
	<style>

	 body {
	     background-color: #AAAAAA;
	 }

	 .canvas {
	     background-color: #000000;

	     position: absolute;
	     top: 10px;
	     right: 100px;
	     width: 500px;
	     height: 500px;
	     border: 3px solid #73AD21;
	 }

	 .STDOUT {
	     background-color: #000000;
	     color: #FFFFFF;
	     font-family: "Terminal", monospace;
	     font-size: 14px;
	     font-weight: bold;
	     resize: none;
	 }
	 
	 .STDIN {
	     background: #1F2124;
	     background: -moz-linear-gradient(#1F2124, #27292C);
	     background: -o-linear-gradient(#1F2124, #27292C);
	     background: -webkit-gradient(linear, 0 0, 0 100%, from(#1F2124), to(#27292C));
	     background: -webkit-linear-gradient(#1F2124, #27292C);
	     background: linear-gradient(#1F2124, #27292C);
	     border: 1px solid #000;
	     box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1);
	     border-radius: 3px;
	     font-size: 14px;
	     font-weight: bold;
	     font-family: 'Terminal', monospace;
	     color: #FFF;
	     width: 654px;
	     height: 25px;
	 }
	     
	 .STDIN:focus {
	     box-shadow: inset 0 0 2px #000;
	     background: linear-gradient(#1F2124, #27292C);
	     border-color: #51CBEE;
	     outline: none;
	 }
	</style>	

	<!-- Load the Paper.js library -->
	<script type="text/javascript" src="js/paper.js"></script>
	<script type="text/paperscript" canvas="myCanvas">

	 var IMG_BASE = new Point(10, 10);
	 var ws = new WebSocket('ws://127.0.0.1:9000', 'emu-protocol');
	 var msp_image = new Raster('msp', IMG_BASE.x + 145.5, 
				    IMG_BASE.y + 192);
	 
	 var stdout = document.getElementById('console');
	 stdout.value = "";

	 function print_console (text){
	     var another = stdout.value + text;
	     stdout.value = another;

	     stdout.scrollTop = stdout.scrollHeight;
	 }

	 var pause_button = document.getElementById('pause_button');
	 var play_button = document.getElementById('play_button');
	 var enter_button = document.getElementById('enter_button');

	 var prev_cmd = "";

	 enter_button.onclick = function(){
	     if (stdin.value == "") {
		 if (prev_cmd != "")
		     stdin.value = prev_cmd;
		 else 
		     return;
	     }
	     else {
		 prev_cmd = stdin.value;
	     }

	     ws.send(stdin.value);
	     stdin.value = "";
	 };

	 pause_button.onclick = function(){
	     ws.send("PAUSE");
	 };

	 play_button.onclick = function(){
	     ws.send("PLAY");
	 };

	 function onMouseDown (event) {
	     ws.send(event.point.x);
	     ws.send(event.point.y);
	     
	     paper.view.update();
	 }

	 // Launchpad red LED builtin at P1.0
	 var P1_0_LED = new Path.Circle( new Point(IMG_BASE.x + 73, 
						   IMG_BASE.y + 375), 
					 6 );
	 P1_0_LED.visible = false;
	 P1_0_LED.style = {
	     fillColor: 'red',
	     strokeColor: 'red',
	     strokeWidth: 5,
	 };
	 P1_0_LED.opacity = 0.7;
	 
	 // Launchpad green LED builtin at P1.6
	 var P1_6_LED = new Path.Circle( new Point(IMG_BASE.x + 90, 
						   IMG_BASE.y + 375), 
					 6 );
	 P1_6_LED.visible = false;
	 P1_6_LED.style = {
	     fillColor: 'green',
	     strokeColor: 'green',
	     strokeWidth: 5,
	 };
	 P1_6_LED.opacity = 0.7;

	 ws.onmessage =  function (event) {
	     var msg = event.data;
	     
	     switch (msg) {
		 case "RED_ON": {
		     P1_0_LED.visible = true;
		     break;
		 }

		 case "RED_OFF": {
		     P1_0_LED.visible = false;
		     break;
		 }

		 case "GREEN_ON": {
		     P1_6_LED.visible = true;
		     break;
		 }

		 case "GREEN_OFF": {
		     P1_6_LED.visible = false;
		     break;
		 }
		     
		 // Line of text for the console
		 default: {
		     print_console(msg);
		     break;
		 }
	     }

	     paper.view.update();
	 };

	 stdin.onkeydown = function auto_enter (event) {
	     // On enter key press
	     if (event.keyCode == 13) {
                 enter_button.click();
	     }
	 };

	</script>
    </head>
    
    <body>
	<textarea id="console" rows="14" cols="80" readonly="readonly" class="STDOUT"></textarea>
	<br>

	<input type="text" id="stdin" width="80" class="STDIN">

	<br><br>

	<button id="enter_button" hidden="true">enter</button> 
	<button id="pause_button" width="100" height="100">Pause</button>
	<button id="play_button" width="100" height="100">Play</button>

	<canvas id="myCanvas" width="340" height="400" class="canvas"></canvas>
	<img id="msp" src="msp.png" alt="msp" hidden="false"></img>
    </body>
</html>
